name: tfsec
on:
  push:
    paths:
      - "**.tf"
      - ".github/workflows/tfsec.yml"
  pull_request:
    paths:
      - "**.tf"
      - ".github/workflows/tfsec.yml"
  workflow_dispatch:

jobs:
  tfsec:
    name: tfsec sarif report
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: [ terraform/modules/remote-dev, terraform/env/prod, terraform/states ]

    steps:
      - name: Clone repo
        uses: actions/checkout@main

      - name: tfsec sarif
        uses: dansanabria/tfsec-sarif-action@fix-url-typo
        with:
          sarif_file: tfsec.sarif
          working_directory: {{ matrix.directory }}

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v1
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: tfsec.sarif    
